<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="./Image/favicon.ico">
  <title>DermaVision</title>
  <link rel="stylesheet" href="./CSS/style.css">
<script type="text/javascript" src="https://me.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=DkMQKkJoYm57owmUEiFNVZk1oaass5Lw2D35b9TJethQlwDjPYLn28tyLuLIk-KhgXq6Ao2MWI5RURlAeZYEFZUa8oJv07QicHpBIM7-QcXdqSjIHQArJhpr8nsmDpdyQgEPn919sUEDVn8mw1je24aIRlUpMRQaOUcAKvBho0fNV-TbJ0oB3gJWxLf12SKJv7ztOYTkf7qDUdcqBD6HLU-muVgHHUAVGFo9i61H0JKGF9sHbk6Efhcd3G-hhwxoOY0AALfLwzAwWCZLeIKsTfWMYRg3PUAIO8lVP-thT7BKAe8DD0p58vtmgZfrHxPLWWZMYqezPI58X2glvL8yMBPfdEO3QGqRkWcT9EaRhCOEf4rMESrCXBkvDcpRu1ZCgza7CmIORdXoCdS88Qkidwqg2YBc5x-3hSQZ1lGTfr7WHXrSztEdDSxwC0TQc1uC8kuUs4mT7-e_wtyIQ7Tc8fMS8EHqqTNFDn92Z-pghKrHa0q-ejQrnkMNLV94LlbsMvrCbRZlRmaw3lsJi2zsFAwDaXqndlGQuvjXIhiNSSpUoyrU7vCmbn_n0AL0LS5p3PfPChVpuug5qDCc8rgCokcJ1_vllWCsGKOUyEj8dURNzGYTFnzjlOp2uVJ8WttFlFzJ3aCjrCVs1g0tram3FhdJ1oLbqmSfq7QIXqTujLVjWG6yd1EQTJO1KrbqxhotTWcucKqnsWqSx1xOmLBMlkBLo0VON7IOaV79tner0bOArIcf1xRxxbWCjELLZm46uCzn4GpOH7J7zdvcsmp7-CobdEMeZQsOLOjkYAhzO2a6qUqY0CQJhO0SEAYGqHDtZmYkNgjFlN47M-ofhsbSrK8xUY8iPzKfKkivc_lHC63gDCPws-cZSfAjiGNoyQxKyX0anotnXCBF8w8pJjRW-3VTwUPSFzsUQvsEfF8MPgqkxaS_IXJG0JsN62EkyQkTfPr72bvDQtYgsfZsIe1GV7QF624YRqGXC5cWfMraDupiV4xnriEjyi0qo3LKCWFz8lhhKgDBNCokpjuPLVdG6EWjTMCWsr0b7peoH5hdC8zfpgZjmJ9fnlhkZ10x0d_zXxMhTHZgLHQjbbEvVrAwsQOMemAT3ZaRwYGMk_yTF2kU7T4EeSES9RflBFS-gvw-YRHqEqAAzan0FQ7_aHrciRj6fNMUahMpd8MK843eRGuaEQKYqGeIs6HkwXnTs2iOhbJNdmZkpOjerxhsHD_-va1tuGjR_KxXKg8A0cqiDk1iXHCR5mJfTHotTki5eP7XydZ_wytxs_WsN-k2y3XZ2S4g4eeuwGbpKzX0JLmAM2DbpKuEP1G1Wm4Q4spk5qhypeBuYWNgqCY1eE2ZpAj2US37o7zWpky2bwxJ3tkd2vzHMLgPnY6LrgfaONRPgQM4dAntBAWW8Qp5WCAhyJtCn4ojCCz3bpk9Z2SLKoOifgwiITmrPVDPHMm5jFm5t4ARQFVPq8QDQrjkrJ7l_Co83mBrQmp0TIonglARmvvKp8dbq2wSCuR5Eoku4m1tbI72bCATkh2e9v3TbzUr8VMUWJwwc1YZ465r2uJ-ECmTWCkKcqOpaqc3qFpKR9nFZ3EdIUmYBZEHwSgMZMHfS2nY2CcvJaBCAztlbypiQ_fqVfJjS9ZO6gqx5lDOZUp3qU6Q_rD99WcOuWpM_5nCPFkUemi5Ut3L-PdibWEg44CtjfDc_jZ2hMRloDBqrHTpfsEtkXeUecIT_fElU8X_oeukbModPN0BK53UdSwUsJXE4hN8lYDHvux_xbYntOl21l1zJMkYmqlWC6XGSOz95pCX8UoA15AWa1AAVgRS7zJLDtP9Fqm-JitVlrKP5up8YTjsZp8G15ViT1PHkLGEIZlubsAr7FU9XyApVwLgjyx_5LIBxYLRmkrofHW5lVve-oodsYhBr2TegCe81G12HA6EWVqH8j0OdB4TSeL2YuUWCVkKu29UJ4_II2386SM8V6Kc7GCopHx_fiipcV1WhHwXmhvh78hS8ztWtS_imkJk6wk" charset="UTF-8"></script></head>

<body>
  <nav class="sidebar">
    <div class="sidebar-header">
      <img src="./Image/logo.png" alt="DermaVision AI Logo" class="logo">
      <button id="close-menu" class="menu-button">&times;</button>
    </div>
    <div class="sidebar-top">
      <a href="./index.html" class="nav-link active">Home</a>
      <a href="./Html/About.html" class="nav-link">About us</a>
    </div>
    <div class="sidebar-bottom">
      <a href="./Html/UA.html" class="nav-link">User Agreements</a>
    </div>
  </nav>

  <div class="main-content">
    <header class="main-header">
      <button id="hamburger-menu" class="menu-button">&#9776;</button>
      <img src="./Image/logo.png" alt="DermaVision AI Logo" class="logo">
    </header>
    <main>
      <div id="upload-form" class="card upload-card">

        <p class="card-title">อัปโหลดผิวหน้า</p>
        <div class="file-upload-wrapper">
          <div class="file-display-box">
            <span id="file-name-text">&lt;No File Chosen...&gt;</span>
            <button id="remove-file-btn" class="remove-file-btn hidden">&times;</button>
          </div>
          <label for="file" class="action-button">อัปโหลด</label>
          <div class="file-size-limit">ไม่เกิน 32 MB</div>
        </div>
        <input id="file" type="file" accept=".jpg,.jpeg,.png,image/jpeg,image/png" class="hidden" />

        <button id="btnUpload" class="process-button" disabled>ประมวลผล</button>
        <p class="disclaimer">ผลลัพธ์จะขึ้นอยู่กับหลายปัจจัย เช่น คุณภาพภาพ, แสงเงา และ ความชัดของภาพ
          ดังนั้นโปรดตรวจสอบก่อนประมวลผล</p>
        <div id="status" class="status"></div>
      </div>

      <div class="card results-card">
        <p class="card-title">ผลลัพธ์</p>
      </div>
    </main>
  </div>

  <div id="wrong-type-modal" class="modal-overlay hidden">
    <div class="modal">
      <p>Wrong File Type!</p>
      <button id="wrong-type-clear-btn" class="modal-button clear-btn">Clear</button>
    </div>
  </div>

  <div id="confirm-clear-modal" class="modal-overlay hidden">
    <div class="modal">
      <button id="close-confirm-modal-btn" class="close-modal-btn">&times;</button>
      <p>Are you sure?</p>
      <button id="confirm-clear-btn" class="modal-button clear-btn">Clear</button>
    </div>
  </div>
  
  <script>
    const API_BASE = "https://6w4jivfjnf.execute-api.us-east-1.amazonaws.com"; // <- ใส่ URL ของ API Gateway

    document.getElementById("btnUpload").addEventListener("click", async () => {
      const status = document.getElementById("status");
      // const userId = document.getElementById("userId").value || "anonymous"; // <- ลบออก
      const file = document.getElementById("file").files[0];
      if (!file) {
        status.textContent = "กรุณาเลือกรูปก่อนอัปโหลด";
        return;
      }

      try {
        status.textContent = "กำลังขอ Presigned URL...";
        const ext = file.name.split('.').pop().toLowerCase() || "jpg";
        
        // --- แก้ไข ---
        // ลบ userId ออกจาก query string
        const pres = await fetch(`${API_BASE}/presign?ext=${ext}`);
        // -------------

        if (!pres.ok) throw new Error("Presign request failed");
        const data = await pres.json(); // data จะมี { key, userId, upload }

        const form = new FormData();
        Object.entries(data.upload.fields).forEach(([k, v]) => form.append(k, v));
        form.append("file", file);

        status.textContent = "กำลังอัปโหลด...";
        const resp = await fetch(data.upload.url, { method: "POST", body: form });
        if (!resp.ok) throw new Error("Upload failed: " + resp.status);

        // --- แก้ไข ---
        // แสดง userId ที่ได้จาก Lambda
        const generatedUserId = data.userId || "N/A";
        status.innerHTML = `✅ อัปโหลดสำเร็จ!<br><b>รหัสของคุณคือ: ${generatedUserId}</b>`;
        // -------------

      } catch (err) {
        status.textContent = "❌ เกิดข้อผิดพลาด: " + err.message;
      }
    });
  </script>

  <script>
    // ---------- NEW UI SCRIPT ----------
    document.addEventListener('DOMContentLoaded', () => {
      // UI Elements
      const hamburgerMenu = document.getElementById('hamburger-menu');
      const closeMenu = document.getElementById('close-menu');
      const sidebar = document.querySelector('.sidebar');
      const fileInput = document.getElementById('file');
      const fileNameText = document.getElementById('file-name-text');
      const removeFileBtn = document.getElementById('remove-file-btn');
      const processBtn = document.getElementById('btnUpload'); // This is the old "Upload" button, now repurposed for "Process"

      // Modals
      const wrongTypeModal = document.getElementById('wrong-type-modal');
      const confirmClearModal = document.getElementById('confirm-clear-modal');
      const wrongTypeClearBtn = document.getElementById('wrong-type-clear-btn');
      const confirmClearBtn = document.getElementById('confirm-clear-btn');
      const closeConfirmModalBtn = document.getElementById('close-confirm-modal-btn');

      const allowedTypes = ['image/jpeg', 'image/png'];

      // --- Sidebar/Menu Logic ---
      if (hamburgerMenu && sidebar) {
        hamburgerMenu.addEventListener('click', () => {
          sidebar.classList.add('open');
        });
      }

      if (closeMenu && sidebar) {
        closeMenu.addEventListener('click', () => {
          sidebar.classList.remove('open');
        });
      }

      // --- File Handling Logic ---
      const resetFileInput = () => {
        fileInput.value = ''; // Clear the selected file
        fileNameText.textContent = '<No File Chosen...>';
        fileNameText.classList.remove('selected');
        removeFileBtn.classList.add('hidden');
        processBtn.disabled = true;
        const statusEl = document.getElementById('status');
        if (statusEl) {
          statusEl.textContent = ''; // Also clear status from old script
        }
      };

      if (fileInput) {
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          if (file) {
            // Validate file type
            if (allowedTypes.includes(file.type)) {
              fileNameText.textContent = file.name;
              fileNameText.classList.add('selected');
              removeFileBtn.classList.remove('hidden');
              processBtn.disabled = false;
            } else {
              // Wrong file type
              resetFileInput();
              wrongTypeModal.classList.remove('hidden');
            }
          } else {
            // If user cancels file selection
            resetFileInput();
          }
        });
      }

      // --- Modal and Button Logic ---
      if (removeFileBtn) {
        removeFileBtn.addEventListener('click', () => {
          confirmClearModal.classList.remove('hidden');
        });
      }

      if (wrongTypeClearBtn) {
        wrongTypeClearBtn.addEventListener('click', () => {
          wrongTypeModal.classList.add('hidden');
        });
      }

      if (confirmClearBtn) {
        confirmClearBtn.addEventListener('click', () => {
          resetFileInput();
          confirmClearModal.classList.add('hidden');
        });
      }

      if (closeConfirmModalBtn) {
        closeConfirmModalBtn.addEventListener('click', () => {
          confirmClearModal.classList.add('hidden');
        });
      }
    });
    // ---------- END NEW UI SCRIPT ----------
  </script>

</body>

</html>
